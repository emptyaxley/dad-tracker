<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dad Tracker Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  html, body, #app {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    overflow: hidden;
  }
</style>
</head>
<body>
<div id="app"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
function loadData() {
  fetch(URL)
    .then(res => res.text())
    .then(text => {
      const jsonText = text.match(/google\.visualization\.Query\.setResponse\((.*)\);/s)[1];
      const table = JSON.parse(jsonText).table;

      const headers = table.cols.map(c => c.label);
      const values = table.rows[0]?.c;

      if (!values) throw new Error("No data found in the sheet.");

      // Build row object
      const row = {};
      headers.forEach((h, i) => row[h] = values[i]?.v || "");

      const app = document.getElementById("app");
      app.innerHTML = "";

      // Safely generate updated string
      const updatedStr = row.updated ? formatUpdated(row.updated) : "N/A";

      // -------- Flight Mode --------
      if (row.mode === "FLYING" && row.flight_id) {
        const iframe = document.createElement("iframe");
        iframe.src = `https://www.airnavradar.com/data/flights/${row.flight_id}`;
        iframe.style.width = "100vw";
        iframe.style.height = "110%";
        iframe.style.border = "none";
        iframe.style.transform = "translateY(-60px)";
        iframe.style.transformOrigin = "top left";
        app.appendChild(iframe);
        return;
      }

      // -------- Ground Mode --------
      const mapDiv = document.createElement("div");
      mapDiv.id = "map";
      mapDiv.style.position = "absolute";
      mapDiv.style.top = "0";
      mapDiv.style.left = "0";
      mapDiv.style.width = "100%";
      mapDiv.style.height = "100%";
      app.appendChild(mapDiv);

      const map = L.map('map', {zoomControl: false, attributionControl: false});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

      const dadLat = row.dad_lat || HOME_LAT;
      const dadLong = row.dad_long || HOME_LONG;

      const dadMarker = L.marker([dadLat, dadLong]).addTo(map).bindPopup("Dad is here").openPopup();
      const homeMarker = L.marker([HOME_LAT, HOME_LONG]).addTo(map).bindPopup("Home").openPopup();
      const line = L.polyline([[HOME_LAT, HOME_LONG], [dadLat, dadLong]], {color: 'blue'}).addTo(map);

      const distance = haversine(HOME_LAT, HOME_LONG, dadLat, dadLong);

      // Floating overlay
      const infoDiv = document.createElement("div");
      infoDiv.style.position = "absolute";
      infoDiv.style.top = "20px";
      infoDiv.style.left = "50%";
      infoDiv.style.transform = "translateX(-50%)";
      infoDiv.style.backgroundColor = "rgba(255,255,255,0.85)";
      infoDiv.style.padding = "15px 25px";
      infoDiv.style.borderRadius = "10px";
      infoDiv.style.textAlign = "center";
      infoDiv.style.zIndex = 1000;
      infoDiv.style.fontFamily = "sans-serif";
      infoDiv.innerHTML = `
        <div style="font-size:2em; font-weight:bold;">Dad is here</div>
        <div style="font-size:1.5em; margin:5px 0;">${row.city || "Unknown"}, ${row.state || ""}</div>
        <div style="font-size:1em; color:gray;">Updated: ${updatedStr}</div>
        <div style="font-size:1.5em; margin-top:5px;">Distance from home: ${distance} miles</div>
      `;
      app.appendChild(infoDiv);

      // Map bounds
      const dadHomeBounds = L.latLngBounds([[HOME_LAT, HOME_LONG], [dadLat, dadLong]]);
      const usBounds = L.latLngBounds([[24.396308, -125.0], [49.384358, -66.93457]]);
      const combinedBounds = dadHomeBounds.extend(usBounds);
      map.fitBounds(combinedBounds, {padding: [50,50]});
    })
    .catch(err => {
      document.getElementById("app").innerHTML =
        `<div style="display:flex;align-items:center;justify-content:center;height:100%;text-align:center;">
          <div><div style="font-size:2em;font-weight:bold;">Error</div><div>${err}</div></div>
        </div>`;
      console.error("Error loading data:", err);
    });
}

// Initial load
loadData();

// Refresh every 5 minutes
setInterval(loadData, 300000);
</script>

</body>
</html>
