<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dad Tracker Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  html, body, #app {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    overflow: hidden;
  }
</style>
</head>
<body>
<div id="app"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const SHEET_ID = "1_n0RQwaGF_WxeujBq8Z04NG_ejzK71VhPa7YJE0WmM4";
const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&headers=1`;

// Boys' home coordinates
const HOME_LAT = 35.3871741;
const HOME_LONG = -84.5345774;

// Haversine distance
function haversine(lat1, lon1, lat2, lon2) {
  const R = 3958.8; // miles
  const toRad = deg => deg * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return (R * c).toFixed(1);
}

// Friendly date formatting
function formatUpdated(rowUpdated) {
  if (!rowUpdated) return "N/A";

  const d = new Date(rowUpdated);
  const now = new Date();

  // Normalize dates to midnight for comparison
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const yesterday = new Date(today);
  yesterday.setDate(today.getDate() - 1);

  const updatedDate = new Date(d.getFullYear(), d.getMonth(), d.getDate());

  if (updatedDate.getTime() === today.getTime()) {
    // Today: show "Today at HH:MM:SS AM/PM"
    const hours = d.getHours() % 12 || 12;
    const minutes = d.getMinutes().toString().padStart(2, "0");
    const seconds = d.getSeconds().toString().padStart(2, "0");
    const ampm = d.getHours() >= 12 ? "PM" : "AM";
    return `Today at ${hours}:${minutes}:${seconds} ${ampm}`;
  } else if (updatedDate.getTime() === yesterday.getTime()) {
    return "Yesterday";
  } else {
    // Older: show days ago
    const diffTime = today - updatedDate; // in milliseconds
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    return `${diffDays} day${diffDays > 1 ? "s" : ""} ago`;
  }
}

function loadData() {
  fetch(URL)
    .then(res => res.text())
    .then(text => {
      const jsonText = text.match(/google\.visualization\.Query\.setResponse\((.*)\);/s)[1];
      const table = JSON.parse(jsonText).table;
      const headers = table.cols.map(c => c.label);
      const values = table.rows[0].c;

      const row = {};
      headers.forEach((h, i) => row[h] = values[i]?.v || "");

      const app = document.getElementById("app");
      app.innerHTML = "";

      const updatedStr = formatUpdated(row.updated);

      // -------- Flight Mode --------
      if (row.mode === "FLYING" && row.flight_id) {
        const iframe = document.createElement("iframe");
        iframe.src = `https://www.airnavradar.com/data/flights/${row.flight_id}`;
        iframe.style.width = "100vw";
        iframe.style.height = "110%";
        iframe.style.border = "none";
        iframe.style.transform = "translateY(-60px)";
        iframe.style.transformOrigin = "top left";
        app.appendChild(iframe);
        return;
      }

      // -------- Ground Mode --------
      const mapDiv = document.createElement("div");
      mapDiv.id = "map";
      mapDiv.style.position = "absolute";
      mapDiv.style.top = "0";
      mapDiv.style.left = "0";
      mapDiv.style.width = "100%";
      mapDiv.style.height = "100%";
      app.appendChild(mapDiv);

      const map = L.map('map', {zoomControl: false, attributionControl: false});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

      const dadMarker = L.marker([row.dad_lat, row.dad_long]).addTo(map).bindPopup("Dad is here").openPopup();
      const homeMarker = L.marker([HOME_LAT, HOME_LONG]).addTo(map).bindPopup("Home").openPopup();
      const line = L.polyline([[HOME_LAT, HOME_LONG], [row.dad_lat, row.dad_long]], {color: 'blue'}).addTo(map);

      const distance = haversine(HOME_LAT, HOME_LONG, row.dad_lat, row.dad_long);

      // Floating overlay
      const infoDiv = document.createElement("div");
      infoDiv.style.position = "absolute";
      infoDiv.style.top = "20px";
      infoDiv.style.left = "50%";
      infoDiv.style.transform = "translateX(-50%)";
      infoDiv.style.backgroundColor = "rgba(255,255,255,0.85)";
      infoDiv.style.padding = "15px 25px";
      infoDiv.style.borderRadius = "10px";
      infoDiv.style.textAlign = "center";
      infoDiv.style.zIndex = 1000;
      infoDiv.style.fontFamily = "sans-serif";
      infoDiv.innerHTML = `
        <div style="font-size:2em; font-weight:bold;">Dad is here</div>
        <div style="font-size:1.5em; margin:5px 0;">${row.city}, ${row.state}</div>
        <div style="font-size:1em; color:gray;">Updated: ${updatedStr}</div>
        <div style="font-size:1.5em; margin-top:5px;">Distance from home: ${distance} miles</div>
      `;
      app.appendChild(infoDiv);

      // Map bounds
      const bounds = L.latLngBounds([[HOME_LAT, HOME_LONG], [row.dad_lat, row.dad_long]]);
      const usBounds = L.latLngBounds([[24.396308, -125.0], [49.384358, -66.93457]]);
      const combinedBounds = bounds.contains(usBounds) ? usBounds : bounds;
      map.fitBounds(combinedBounds, {padding: [50,50]});
    })
    .catch(err => {
      document.getElementById("app").innerHTML =
        `<div style="display:flex;align-items:center;justify-content:center;height:100%;text-align:center;">
          <div><div style="font-size:2em;font-weight:bold;">Error</div><div>${err}</div></div>
        </div>`;
    });
}

// Initial load
loadData();

// Refresh every minute
setInterval(loadData, 60000);
</script>
</body>
</html>
